<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Cards Game</title>
  <style>
    .room-content {
      display: none;
    }
    #game-board {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            margin-top: 50px;
        }
        .memory-card {
            background-color: #204051;
            width: calc(25% - 10px);
            height: 150px;
            margin-bottom: 10px;
            border-radius: 5px;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .invisible {
        visibility: hidden;
    }
  </style>
</head>
<body>
  <div>
    <div class="main-content" id="main-content">
      <div role="alert" id="turn-message"></div>
      <div id="user-card">
        <div>
          <form method="POST" id="form">
            <div>
              <label for="username">Nom d'utilisateur</label>
              <input type="text" id="username" minlength="2" maxlength="20" placeholder="Saisir votre nom d'utilisateur" required>
            </div>
            <button id="savePseudo" type="submit">Enregistrer pseudo</button>
            <button id="createRoomButton">CrÃ©ation d'une salle</button>
            <input type="text" id="roomNameInput" placeholder="Nom de la salle">
          </form>
        </div>
      </div>
      <div id="rooms-card">
        <div>Salons disponibles</div>
        <ul id="rooms-list"></ul>
      </div>
    </div>
    <div class="room-content">
      <h2>Vous Ãªtes dans la salle :<span> </span></h2>
      <button id="leaveButton">Quitter la salle</button>
      <div id="game-area">
        <div id="game-board"></div>
      </div>
    </div>
  </div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-2huaZvOR9iDzHqslqwpR87isEmrfxqyWOF7hr7BY6KG0+hVKLoEXMPUJw3ynWuhO" crossorigin="anonymous"></script>
  <script>
    const socket = io();
    let currentRoom;

    //Enregistrement du username de l'utilisateur
    document.getElementById("form").addEventListener("submit", function (event) {
      event.preventDefault();
      let username = document.getElementById("username").value;
      socket.emit("setUsername", username);
    });

    //creation d'une salle de jeu
    document.getElementById('createRoomButton').addEventListener('click', function(event) {
      event.preventDefault();
      const roomName = document.getElementById('roomNameInput').value;
      if (roomName) {
        socket.emit('createRoom', roomName);
      } else {
        console.log('Please enter a room name');
      }
    });

    //leave la salle
    document.getElementById('leaveButton').addEventListener('click', function() {
      if (currentRoom) {
        socket.emit('leave', currentRoom);
        document.querySelector('.room-content').style.display = 'none';
        document.querySelector('.main-content').style.display = 'block';
      }
    });

    //recuperation des salles de jeu quand quelquun accede a la page
    socket.on('connect', function() {
      socket.emit('getRooms');
    });

    socket.on('roomsList', (rooms) => {
      const roomsList = document.getElementById('rooms-list');
      roomsList.innerHTML = ''; 

      //display des room avec createur et si c'est full ou non
      rooms.forEach(({ room, creator, isFull }) => { 
        const creator_details_room = document.createElement('li');
        creator_details_room.textContent = room + ' crÃ©e par ' + creator;

        const joinButton = document.createElement('button');
        joinButton.textContent = 'Rejoindre la salle';

        if (isFull) {
          joinButton.disabled = true;
          const space = document.createElement('span');
          space.textContent = ' (Full)';
          creator_details_room.appendChild(space);
        }

        //join la salle
        joinButton.addEventListener('click', () => {

          //si la salle n'est pas pleine
          if (!isFull) {
            currentRoom = room; 
            socket.emit('joinRoom', room);
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.room-content').style.display = 'block';

            socket.emit('roomJoined', room);
          } else {
            alert('La salle est pleine !');
          }
        });

        roomsList.appendChild(creator_details_room);
        roomsList.appendChild(joinButton);
      });
    });

    //quand un utilisateur rejoint une salle
    socket.on("userJoined", ({ user, room }) => {
      document.querySelector('.main-content').style.display = 'none';
      document.querySelector('.room-content').style.display = 'block';

      const message = document.createElement("p");
      message.textContent = `${user} a rejoint ${room}`;
      document.querySelector(".room-content").appendChild(message);

      document.querySelector("h2 span").textContent = " " + room;
    });

    //la salle est pleine contenu
    socket.on('roomIsFull', () => {
      console.log('room full');
      document.querySelector('.main-content').style.display = 'none';
      document.querySelector('.room-content').style.display = 'block';

      const startButton = document.createElement('button');
      startButton.textContent = 'Commencer la partie';
      startButton.id = 'start-game-button'; 
      document.querySelector('.room-content').appendChild(startButton);

      startButton.addEventListener('click', () => {
        console.log('cool click sur le start button');
        socket.emit('gameStarted', currentRoom);
      });
    });

    //la salle est pleine et on ne peut pas la rejoindre 
    socket.on('roomFullAndCannotJoin', () => {
      alert('La salle que vous souhaitez rejoindre est pleine !');
      document.querySelector('.main-content').style.display = 'block';
      document.querySelector('.room-content').style.display = 'none';
    });

    //quand un utilisateur quitte la salle
    socket.on("leave", function ({ user, room }) {
      console.log(`${user} a quittÃ© la salle ${room}`);

      const message = document.createElement("p");
      message.textContent = `${user} a quittÃ© la salle : ${room}`;
      document.querySelector(".room-content").appendChild(message);
    });

    // une fois le bouton start game cliquÃ©
    socket.on('gameStarted', () => {
      // const p = document.createElement('p');
      // p.textContent = 'Hello c le jeu qui sera ici';
      // document.querySelector('.room-content').appendChild(p);

      // Rendre le bouton startButton invisible
    const startButton = document.getElementById('start-game-button');
    if (startButton) {
      startButton.style.display = 'none';
    }

      generateMemoryCards(); // GÃ©nÃ©rer les cartes de mÃ©moire
    });


    // crÃ©ation du jeu de mÃ©moire

    let flippedCards = []; // Cartes retournÃ©es

    function generateMemoryCards() {
      const gameBoard = document.getElementById('game-board');
      const cardValues = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']; // Paires de valeurs de cartes

      // MÃ©langer les valeurs de cartes
      cardValues.sort(() => Math.random() - 0.5);

      for (let i = 0; i < cardValues.length; i++) {
          const card = document.createElement('div');
          card.classList.add('memory-card');
          card.dataset.value = cardValues[i];
          card.textContent = card.dataset.value; // Afficher initialement la valeur de la carte
          card.addEventListener('click', flipCard);
          gameBoard.appendChild(card);
      }

      // Retourner toutes les cartes face cachÃ©e aprÃ¨s 4 secondes
      setTimeout(() => {
          const cards = document.querySelectorAll('.memory-card');
          cards.forEach(card => {
              card.textContent = 'ðŸŽ´'; // Emoji pour une carte face cachÃ©e
          });
      }, 4000);
    }

    // Fonction pour retourner une carte
    function flipCard(event) {
        const card = event.target;
        card.textContent = card.dataset.value; // Afficher la valeur de la carte
        flippedCards.push(card); // Ajouter la carte aux cartes retournÃ©es

        // Si deux cartes ont Ã©tÃ© retournÃ©es, vÃ©rifier si elles correspondent
        if (flippedCards.length === 2) {
            if (flippedCards[0].dataset.value === flippedCards[1].dataset.value) {
                // Les cartes correspondent, les rendre invisibles aprÃ¨s un dÃ©lai
                setTimeout(() => {
                    flippedCards[0].classList.add('invisible');
                    flippedCards[1].classList.add('invisible');
                    flippedCards = [];
                }, 1000);
            } else {
                // Les cartes ne correspondent pas, les retourner face cachÃ©e aprÃ¨s un dÃ©lai
                setTimeout(() => {
                    flippedCards[0].textContent = 'ðŸŽ´';
                    flippedCards[1].textContent = 'ðŸŽ´';
                    flippedCards = [];
                }, 1000);
            }
        }

                // Envoyer un Ã©vÃ©nement au serveur pour indiquer qu'une carte a Ã©tÃ© retournÃ©e
        socket.emit('cardFlipped', { value: card.dataset.value, index: Array.from(gameBoard.children).indexOf(card) });
    }
  </script>
</body>
</html>
